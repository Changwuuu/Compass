
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Micropooling &#8212; Compass 2021 documentation</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Compass Postprocessing" href="Compass-Postprocessing-Tutorial.html" />
    <link rel="prev" title="Compass Settings" href="Compass-Settings.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="index.html">
    
      <p class="title">Compass</p>
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="install.html">Installing Compass</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="user-guide.html">Compass User Guide</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
          
            
                <li class="">
                    <a href="tutorial.html">Tutorial</a>
                </li>
            
          
            
                <li class="">
                    <a href="Compass-Settings.html">Compass Settings</a>
                </li>
            
          
            
                <li class="active">
                    <a href="">Micropooling</a>
                </li>
            
          
            
                <li class="">
                    <a href="Compass-Postprocessing-Tutorial.html">Compass Postprocessing</a>
                </li>
            
          
            
                <li class="">
                    <a href="AWS-tutorial.html">AWS Tutorial</a>
                </li>
            
          
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#using-micropooling" class="nav-link">Using Micropooling</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#example-of-micropooling" class="nav-link">Example of Micropooling</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#micropooling-settings" class="nav-link">Micropooling Settings</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="micropooling">
<h1>Micropooling<a class="headerlink" href="#micropooling" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#using-micropooling" id="id1">Using Micropooling</a></p></li>
<li><p><a class="reference internal" href="#example-of-micropooling" id="id2">Example of Micropooling</a></p></li>
<li><p><a class="reference internal" href="#micropooling-settings" id="id3">Micropooling Settings</a></p></li>
</ul>
</div>
<p>To help the Compass algorithm scale to larger datasets we use micropooling/microclustering to aggregate samples into clusters which are analyzed with the Compass algorithm which can dramatically lower computational burdens.
The micropooling algorithm is a reimplementation of micropooling using <a class="reference external" href="https://www.nature.com/articles/s41467-019-12235-0">VISION</a>.</p>
<p>In short, the algorithm works by first coarsely clustering samples using the Louvain/Leiden algorithm on the k-nearest neighbors (kNN) graph of the gene expression data and then iteratively applying k-means clustering until the clusters are the correct average size.
Each cluster is then treated as a sample where the gene expression is the average of the gene expression for samples in the cluster and the Compass algorithm can be applied to a smaller number of samples.
If you specify a latent space, the K-nearest neighbor graph will instead be computed using that latent space. You may also specify the kNN graph directly (see in command line arguments).</p>
<div class="section" id="using-micropooling">
<h2><a class="toc-backref" href="#id1">Using Micropooling</a><a class="headerlink" href="#using-micropooling" title="Permalink to this headline">¶</a></h2>
<p>To enable micropooling using Compass, set the parameter --microcluster-size and the input data will first be clustered into pools before applying the Compass algorithm.
The micropool assignments will be written to the --microcluster-file in the output directory (by default micropools.tsv) as a tab-delimited table.
The reactions.tsv file that is output will now be a table of reaction penalties per micropool, analogous to the usual Compass output file but applied to the micropooled data.</p>
<p>To analyze the micropooled results we would instead characterize the micropools.
* Numeric cell metadata (e.g., library size) can be averaged across cells in the micropool.
* Discrete cell metadata (e.g., belonging to KO or WT) can be decided by majority decision, or if at least 90% (or some other threshold) of the cells in the micropool belong to one of the discrete phenotypes.</p>
<blockquote>
<div><p>Depending on the research question, it could make sense to micropool discrete phenotypes separately. This will result in micrpools made of only WT or KO cells, for example, but may conceal some of the overlapping cellular programs between the two.</p>
</div></blockquote>
</div>
<div class="section" id="example-of-micropooling">
<h2><a class="toc-backref" href="#id2">Example of Micropooling</a><a class="headerlink" href="#example-of-micropooling" title="Permalink to this headline">¶</a></h2>
<p>As in the tutorial, to use microclustering first open a command line in a directory with the gene expression data of interest, say “expression.tsv”. You can then run Compass on the data with the following command using micropooling:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>compass --data expression.tsv --num-processes <span class="m">10</span> --microcluster-size <span class="m">10</span> --species homo_sapiens
</pre></div>
</div>
<p>Once the command has finished running, there should be 3 output files in the same directory the command was run: reactions.tsv, micropools.tsv, and micropooled_data.tsv.
Reactions.tsv contains the penalties per reaction for each micropool, micropools.tsv contains the micropool assignments for each of the original samples, and micropooled_data.tsv contains the average gene expression for each micropool.</p>
</div>
<div class="section" id="micropooling-settings">
<h2><a class="toc-backref" href="#id3">Micropooling Settings</a><a class="headerlink" href="#micropooling-settings" title="Permalink to this headline">¶</a></h2>
<p>Micropooling also works with precomputed k-nearest neighbors and/or a latent space to cluster samples on.
The code is designed for specifying k-nearest neighbors using the results from scikit-learn’s nearest neighbors algorithm, which are an array of indices and an array of distances, possibly wrapped in a Pandas dataframe so that rows can be indexed by sample name.</p>
<p>For the k-nearest neighbors step, if there are specified k-nearest neighbors indices but not distances, the distances will be computed using the latent space (or raw gene expression if no latent space is specified).
If a latent space is specified, both k-nearest neighbors and the k-means clustering steps will use it.
Note that specifying a k-nearest neighbors computed on a latent space without inputing that latent space may cause unusual clustering results because k-means will be run using gene expression data unless it has access to the latent space.</p>
<p>If there is information sharing as well as micropooling, the input knn will only be used with the micropooling because the knn does not apply to the micropools.</p>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="Compass-Settings.html" title="previous page">Compass Settings</a>
    <a class='right-next' id="next-link" href="Compass-Postprocessing-Tutorial.html" title="next page">Compass Postprocessing</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2021, Yosef Lab.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>